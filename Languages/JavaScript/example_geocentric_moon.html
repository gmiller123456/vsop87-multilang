<html>
<head></head>
<body>
Simple example to compute the geocentric position of them moon.  Note the reduction algorithm
used is not rigorous, it ignores several factors, like annual abberation, which will result in
a error of many arc seconds.  This example requires vsop87a_full.js.<br><br>
Result:
<pre id="output"></pre>

Values from JPL Horizons<br>
-10.90338<br>
222.45893<br>
14h 49m 50.14s<br>
-10d 54' 12.2"<br>


<script src="vsop87a_full.js"></script>
<script>

testMoon();

function display(s){
	const o=document.getElementById("output");
	o.innerHTML=o.innerHTML+s;
}

//Converts a Julan Date to Julian centuries since J2000, which is what VSOP expects as input
function jd2et(jd){
	return (jd - 2451545.0) / 365250.0;

}

//Converts cartesian XYZ coordinates to polar (e.g. Right Accention and Declication)
function toPolar(xyz){
	let t = new Array();
	t[0] = Math.sqrt(xyz[0] * xyz[0] + xyz[1] * xyz[1] + xyz[2] * xyz[2]);
	t[1] = Math.acos(xyz[2] / t[0]);
	t[2] = Math.atan2(xyz[1], xyz[0]);

	return t;
}

//Subtracts two arrays (vectors), a-b
function sub(a, b){
	let t = new Array();
	t[0] = a[0] - b[0];
	t[1] = a[1] - b[1];
	t[2] = a[2] - b[2];
	return t;
}

function displayPolar(b){
	let temp=b[2];
	if(temp<0) temp+=2*Math.PI;
	const ra=(temp * 180 / Math.PI);
	const dec=(90 - b[1] * 180 / Math.PI);
	display("RA:"+ra + "\r\n");
	display("DEC:"+dec + "\r\n");
}

function displayDms(d){
	let t = 90 - d * 180 / Math.PI;
	let deg = Math.trunc(t);
	t = Math.abs(t) - Math.abs(deg);
	t *= 60;
	let min = Math.trunc(t);
	t -= min;
	let sec = t * 60;
	display(deg + "d " + min + "' " + sec + "\"\r\n");
}

function displayHms(h){
	let t = h * 180 / Math.PI+360;
	t /= 15.0;
	let hours = Math.trunc(t);
	t = Math.abs(t) - Math.abs(hours);
	t *= 60;
	let min = Math.trunc(t);
	t -= min;
	let sec = t * 60;
	display(hours + "h " + min + "m " + sec + "s\r\n");
}

function displayCart(b){
	console.log(b[0]);
	console.log(b[1]);
	console.log(b[2]);
}

function rotate(x, angle){
	let t = new Array();
	t[0] = x[0];
	t[1] = x[1] * Math.cos(angle) - x[2] * Math.sin(angle);
	t[2] = x[1] * Math.sin(angle) + x[2] * Math.cos(angle);
	return t;
}

function rotvsop2J2000(x){
	/* From VSOP87.doc
	  X        +1.000000000000  +0.000000440360  -0.000000190919   X
	  Y     =  -0.000000479966  +0.917482137087  -0.397776982902   Y
	  Z FK5     0.000000000000  +0.397776982902  +0.917482137087   Z VSOP87A
	*/
	let t = new Array();
	t[0] = x[0] + x[1] * 0.000000440360 + x[2] * -0.000000190919;
	t[1] = x[0] * -0.000000479966 + x[1] * 0.917482137087 + x[2] * -0.397776982902;
	t[2] = x[1] * 0.397776982902 + x[2] * 0.917482137087;

	return t;
}

//Converts a Julian Date in UTC to TIA
function convertUTCtoTT(jd){
	//32 leap seconds is hard coded as of Jan 2000, should be updated from the IERS website for other times
	
	//TAI = UTC + leap seconds (e.g. 32)
	//TT=TAI + 32.184
	
	return jd + (32.0 + 32.184) / 24.0 / 60.0 / 60.0
}

function testMoon(){
	const jd=2451545.000000; //Jan 1 2000, 12:00p UTC
	const jdTT = convertUTCtoTT(jd);
	let t = jd2et(jdTT);
	
	//Get current position of Earth
	const earth = vsop87a_full.getEarth(t);
	
	//Get current position of Moon
	let moon = vsop87a_full.getMoon(vsop87a_full.getEarth(t), vsop87a_full.getEmb(t));
	moon = sub(moon, earth);

	//Calculate light time to moon, then recalculate Moon position adjusted for light time
	let distance = Math.sqrt(moon[0] * moon[0] + moon[1] * moon[1] + moon[2] * moon[2]);
	distance*=1.496e+11 //Convert from AU to meters
	display("Distance="+(distance)+" meters\r\n");
	const lightTime=distance/299792458.0;
	display("Light Time="+lightTime+" seconds\r\n");

	//Convert light time to Julian Centuries, and subtract it from the original value of t
	t-=lightTime / 24.0 / 60.0 / 60.0 / 365250.0;  
	moon = vsop87a_full.getMoon(vsop87a_full.getEarth(t), vsop87a_full.getEmb(t));
	
	//Convert to Geocrntric position
	moon = sub(moon, earth);

	//Rotate ecliptic coordinates to J2000 coordinates
	moon = rotvsop2J2000(moon);
	
	moon = toPolar(moon);
	//moon now holds the RA and DEC, display them in decimal and verbose form

	displayPolar(moon);

	displayHms(moon[2]);
	displayDms(moon[1]);

}

</script></body></html>