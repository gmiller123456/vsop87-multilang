<html>
<head></head>
<body>
<script src="vsop87a_full.js"></script>
<script>

testMoon();

//Converts a Julan Date to Julian centuries since J2000, which is what VSOP expects as input
function jd2et(jd){
	return (jd - 2451545.0) / 365250.0;

}

//Converts cartesian XYZ coordinates to polar (e.g. Right Accention and Declication)
function toPolar(xyz){
	let t = new Array();
	t[0] = Math.sqrt(xyz[0] * xyz[0] + xyz[1] * xyz[1] + xyz[2] * xyz[2]);
	t[1] = Math.acos(xyz[2] / t[0]);
	t[2] = Math.atan2(xyz[1], xyz[0]);

	return t;
}

//Subtracts two arrays (vectors), a-b
function sub(a, b){
	let t = new Array();
	t[0] = a[0] - b[0];
	t[1] = a[1] - b[1];
	t[2] = a[2] - b[2];
	return t;
}

function displayPolar(b){
	let temp=b[2];
	if(temp<0) temp+=2*Math.PI;
	const ra=(temp * 180 / Math.PI);
	const dec=(90 - b[1] * 180 / Math.PI);
	console.log("RA:"+ra);
	console.log("DEC:"+dec);
}

function displayDms(d){
	let t = 90 - d * 180 / Math.PI;
	let deg = Math.trunc(t);
	t = Math.abs(t) - Math.abs(deg);
	t *= 60;
	let min = Math.trunc(t);
	t -= min;
	let sec = t * 60;
	console.log(deg + "d " + min + "m " + sec);
}

function displayHms(h){
	let t = h * 180 / Math.PI+360;
	t /= 15.0;
	let hours = Math.trunc(t);
	t = Math.abs(t) - Math.abs(hours);
	t *= 60;
	let min = Math.trunc(t);
	t -= min;
	let sec = t * 60;
	console.log(hours + "h " + min + "m " + sec);
}

function displayCart(b){
	console.log(b[0]);
	console.log(b[1]);
	console.log(b[2]);
}

function rotate(x, angle){
	let t = new Array();
	t[0] = x[0];
	t[1] = x[1] * Math.cos(angle) - x[2] * Math.sin(angle);
	t[2] = x[1] * Math.sin(angle) + x[2] * Math.cos(angle);
	return t;
}

function rotvsop2J2000(x){
	/* From VSOP87.doc
	  X        +1.000000000000  +0.000000440360  -0.000000190919   X
	  Y     =  -0.000000479966  +0.917482137087  -0.397776982902   Y
	  Z FK5     0.000000000000  +0.397776982902  +0.917482137087   Z VSOP87A
	*/
	let t = new Array();
	t[0] = x[0] + x[2] * -0.000000190919;
	t[1] = x[0] * -0.000000479966 + x[1] * 0.917482137087 + x[2] * -0.397776982902;
	t[2] = x[1] * 0.397776982902 + x[2] * 0.917482137087;

	return t;
}

//Converts a Julian Date in UTC to TIA
function convertUTCtoTAI(jd){
	//32 leap seconds is hard coded as of Jan 2000, should be updated from the IERS website for other times
	return jd + (32.0 + 32.184) / 24.0 / 60.0 / 60.0
}

function testMoon(){
	const jd=2451545.000000; //Jan 1 2000, 12:00p UTC
	let jdTAI = convertUTCtoTAI(jd);
	let t = jd2et(jdTAI);
	
	//Get current position of Earth
	const earth = vsop87a_full.getEarth(t);
	
	//Get current position of Moon
	let moon = vsop87a_full.getMoon(vsop87a_full.getEarth(t), vsop87a_full.getEmb(t));
	moon = sub(moon, earth);

	//Calculate time time to moon, and recalculate Moon position adjusted for light time
	let distance = Math.sqrt(moon[0] * moon[0] + moon[1] * moon[1] + moon[2] * moon[2]);
	distance*=1.496e+11 //Convert from AU to meters
	console.log("Distance="+(distance)+" meters");
	const lightTime=distance/299792458.0;
	console.log("Light Time="+lightTime+" seconds");

	jdTAI = convertUTCtoTAI(2451545.000000) - lightTime / 24.0 / 60.0 / 60.0;
	t = jd2et(jdTAI);
	moon = vsop87a_full.getMoon(vsop87a_full.getEarth(t), vsop87a_full.getEmb(t));
	moon = sub(moon, earth);

	moon = rotvsop2J2000(moon);
	moon = toPolar(moon);
	displayPolar(moon);

	displayHms(moon[2]);
	displayDms(moon[1]);

	console.log("\r\nValues from JPL Horizons\r\n");
	console.log("\r\n-10.90338\r\n222.45893\r\n");
	console.log("\r\n14 49 50.14\r\n-10 54 12.2\r\n");
}

</script></body></html>